<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HW 11: Euler-Maruyama SDE Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* CLEAN PROFESSIONAL THEME */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        /* Navigation Links */
        .nav-links { margin-bottom: 20px; font-size: 0.9em; }
        .nav-links a { text-decoration: none; color: #3498db; margin-right: 15px; font-weight: bold; }
        .nav-links a:hover { text-decoration: underline; color: #2980b9; }

        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        
        /* Input Controls */
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; background: #f1f3f5; padding: 20px; border-radius: 8px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        .control-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Run Button */
        button { grid-column: 1 / -1; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; font-weight: 600; }
        button:hover { background-color: #2980b9; }
        
        /* Charts Layout */
        .charts-area { display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 20px; }
        canvas { background: #fff; border: 1px solid #eee; border-radius: 4px; }
        
        /* Stats Box */
        .stats-panel { margin-top: 20px; padding: 15px; background-color: #e8f6f3; border-left: 5px solid #1abc9c; border-radius: 4px; }
        
        /* Theory Section */
        .theory-section { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-links">
        <a href="index.html">← Back to Index</a>
        <a href="homework10.html">← Previous: Homework 10</a>
    </div>

    <h1>Homework 11: Euler-Maruyama SDE Simulation</h1>
    <p>Simulating a Generalized Wiener Process (Brownian Motion with Drift) using the Euler-Maruyama numerical method.</p>

    <div class="controls">
        <div class="control-group">
            <label for="mu">Drift ($\mu$)</label>
            <input type="number" id="mu" value="0" step="0.1">
        </div>
        <div class="control-group">
            <label for="sigma">Diffusion ($\sigma$)</label>
            <input type="number" id="sigma" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label for="timeHorizon">Time ($T$)</label>
            <input type="number" id="timeHorizon" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label for="steps">Steps ($n$)</label>
            <input type="number" id="steps" value="1000">
        </div>
        <div class="control-group">
            <label for="numPaths">Simulations ($m$)</label>
            <input type="number" id="numPaths" value="50">
        </div>
        <button onclick="runSimulation()">Run Simulation</button>
    </div>

    <div class="stats-panel" id="statsOutput">
        <strong>Calculating...</strong>
    </div>

    <div class="charts-area">
        <div>
            <h3>Sample Paths (Process $X_t$)</h3>
            <canvas id="pathsChart"></canvas>
        </div>
        <div>
            <h3>Distribution at Final Time $T$</h3>
            <canvas id="histoChart"></canvas>
        </div>
    </div>

    <div class="theory-section">
        <h3>Theoretical Background</h3>
        <p>This homework generalizes the Random Walk (HW 7) to continuous time by solving the Stochastic Differential Equation (SDE):</p>
        <p style="text-align: center; font-size: 1.2em;">
            $$ dX_t = \mu dt + \sigma dW_t $$
        </p>
        <p>Using the <strong>Euler-Maruyama</strong> discretization method:</p>
        <p style="text-align: center; font-size: 1.1em;">
            $$ X_{i+1} = X_i + \mu \Delta t + \sigma \sqrt{\Delta t} Z_i $$
        </p>
        <p>Where $Z_i \sim N(0,1)$ is a standard normal random variable generated via the <strong>Box-Muller transform</strong>.</p>
        <ul>
            <li>If $\mu = 0$ and $\sigma = 1$, this is a standard Wiener Process.</li>
            <li>If $\mu \neq 0$, the process has a deterministic trend (drift).</li>
        </ul>
    </div>
</div>

<script>
    let pathsChartInstance = null;
    let histoChartInstance = null;

    // --- 1. Box-Muller Transform (Normal Random Generator) ---
    function boxMullerTransform() {
        let u1 = 0, u2 = 0;
        while(u1 === 0) u1 = Math.random(); 
        u2 = Math.random();
        return Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
    }

    // --- 2. Main Simulation Function ---
    function runSimulation() {
        // Inputs
        const T = parseFloat(document.getElementById('timeHorizon').value);
        const n = parseInt(document.getElementById('steps').value);
        let m = parseInt(document.getElementById('numPaths').value);
        const mu = parseFloat(document.getElementById('mu').value);
        const sigma = parseFloat(document.getElementById('sigma').value);

        // Limit paths for visual clarity in the colored chart
        if (m > 50) {
            m = 50;
            document.getElementById('numPaths').value = 50;
            alert("Number of simulations limited to 50 for better visual clarity with colors.");
        }

        const dt = T / n;
        const sqrt_dt = Math.sqrt(dt);

        const trajectories = []; 
        const finalPositions = [];
        const timeLabels = [];

        // Generate Labels for EVERY step to ensure full detail
        for (let i = 0; i <= n; i++) {
            timeLabels.push((i * dt).toFixed(3));
        }

        // Run Paths
        for (let path = 0; path < m; path++) {
            let X = 0; 
            const singlePath = [0]; 

            for (let step = 1; step <= n; step++) {
                const Z = boxMullerTransform();
                
                // Euler-Maruyama Formula
                const dX = (mu * dt) + (sigma * sqrt_dt * Z);
                X += dX;
                
                // Store EVERY point for maximum detail (wiggliness)
                singlePath.push(X);
            }
            trajectories.push(singlePath);
            finalPositions.push(X);
        }

        // Statistics
        const mean = finalPositions.reduce((a, b) => a + b, 0) / m;
        const variance = finalPositions.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / m;
        const theoMean = mu * T;
        const theoVar = Math.pow(sigma, 2) * T;

        // Update Stats Panel
        const statsPanel = document.getElementById('statsOutput');
        statsPanel.innerHTML = `
            <strong>Results (t=${T}, m=${m}):</strong><br>
            Empirical Mean: ${mean.toFixed(4)} (Theoretical: ${theoMean.toFixed(4)})<br>
            Empirical Variance: ${variance.toFixed(4)} (Theoretical: ${theoVar.toFixed(4)})
        `;
        if(window.MathJax) { window.MathJax.typesetPromise([statsPanel]); }

        // Draw Charts
        drawPathsChart(timeLabels, trajectories);
        drawHistogram(finalPositions, sigma, T, mu);
    }

    // --- 3. Chart Drawing Functions ---
    function drawPathsChart(labels, dataSets) {
        const ctx = document.getElementById('pathsChart').getContext('2d');
        
        // A palette of distinct, beautiful colors
        const colorPalette = [
            'rgba(231, 76, 60, 0.7)',   // Red
            'rgba(52, 152, 219, 0.7)',  // Blue
            'rgba(46, 204, 113, 0.7)',  // Green
            'rgba(155, 89, 182, 0.7)',  // Purple
            'rgba(241, 196, 15, 0.7)',  // Yellow
            'rgba(230, 126, 34, 0.7)',  // Orange
            'rgba(22, 160, 133, 0.7)',  // Teal
            'rgba(52, 73, 94, 0.7)'     // Dark Blue/Grey
        ];

        const pathsToDraw = dataSets.map((data, index) => {
            // Cycle through the color palette
            const color = colorPalette[index % colorPalette.length];
            return {
                label: `Path ${index + 1}`,
                data: data,
                borderColor: color,
                borderWidth: 1.5, // Slightly thicker lines
                pointRadius: 0,
                fill: false,
                tension: 0 // No smoothing, shows the real jagged path
            };
        });

        if (pathsChartInstance) pathsChartInstance.destroy();

        pathsChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: pathsToDraw },
            options: {
                animation: false,
                responsive: true,
                interaction: { mode: 'nearest', intersect: false },
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { enabled: true } 
                },
                scales: { 
                    x: { 
                        title: { display: true, text: 'Time (t)' }, 
                        ticks: { maxTicksLimit: 8, maxRotation: 0 } 
                    },
                    y: { title: { display: true, text: 'Value X(t)' } }
                }
            }
        });
    }

    function drawHistogram(data, sigma, T, mu) {
        const ctx = document.getElementById('histoChart').getContext('2d');
        const binCount = Math.max(15, Math.floor(Math.sqrt(data.length))); // Dynamic bin count
        const min = Math.min(...data);
        const max = Math.max(...data);
        const interval = (max - min) / binCount;
        
        const bins = new Array(binCount).fill(0);
        const binLabels = [];
        
        for (let i = 0; i < binCount; i++) {
            const center = min + (i * interval) + (interval/2);
            binLabels.push(center.toFixed(2));
        }

        data.forEach(val => {
            const index = Math.min(Math.floor((val - min) / interval), binCount - 1);
            bins[index]++;
        });

        const theoreticalData = binLabels.map(x => {
            const xVal = parseFloat(x);
            const theoMean = mu * T;
            const theoSd = sigma * Math.sqrt(T);
            const exponent = -0.5 * Math.pow((xVal - theoMean) / theoSd, 2);
            const pdf = (1 / (theoSd * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);
            return pdf * data.length * interval; 
        });

        if (histoChartInstance) histoChartInstance.destroy();

        histoChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: binLabels,
                datasets: [
                    {
                        label: 'Empirical Freq.',
                        data: bins,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    },
                    {
                        type: 'line',
                        label: 'Theoretical Normal',
                        data: theoreticalData,
                        borderColor: '#e74c3c',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: { x: { title: { display: true, text: 'Final Position X(T)' } } }
            }
        });
    }

    // --- 4. AUTO-RUN ON LOAD ---
    window.onload = function() {
        // Set a default of 50 paths for the best colored view
        document.getElementById('numPaths').value = 50;
        runSimulation();
    };

</script>

</body>
</html>
